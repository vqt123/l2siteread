<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SightRead SRS - Smart Music Trainer</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- VexFlow for Music Notation -->
    <script src="https://unpkg.com/vexflow@3.0.9/releases/vexflow-min.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-slate-900 text-white h-screen flex flex-col overflow-hidden">

    <!-- Header / Stats -->
    <div class="flex-none p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-indigo-400 tracking-tight">SightRead<span class="text-white font-light">SRS</span></h1>
            <div class="text-xs text-slate-400 mt-1 flex items-center gap-2">
                <div>Unlocked: <span id="unlocked-disp" class="text-white font-bold">3</span> notes (<span id="ready-disp" class="text-indigo-400">0</span> ready)</div>
                <div class="w-24 h-2 bg-slate-700 rounded-full overflow-hidden">
                    <div id="mastery-bar" class="h-full bg-indigo-500 progression-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="btn-export-logs" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg transition text-sm flex items-center gap-2" title="Export troubleshooting logs">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Export Logs
            </button>
            <button id="btn-settings" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg transition text-sm flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                </svg>
                Settings
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-area" class="flex-grow flex flex-col items-center justify-center relative bg-white transition-colors duration-300">
        
        <!-- Feedback Overlay -->
        <div id="feedback-text" class="absolute top-8 text-3xl font-bold opacity-0 transition-opacity pointer-events-none z-10 text-center"></div>

        <!-- Music Notation Canvas -->
        <div id="notation-container" class="w-full max-w-4xl flex justify-center items-center p-2 overflow-hidden"></div>

        <!-- Hint Text -->
        <div class="text-slate-400 text-sm mt-2 mb-4 h-6 font-medium" id="hint-text">
            Speed goal: < 2.5s
        </div>

        <!-- Microphone Status -->
        <div id="mic-status" class="hidden text-center mb-4">
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-slate-800 rounded-lg border border-slate-700">
                <div id="mic-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span class="text-sm text-slate-300">Listening for notes...</span>
                <button id="btn-stop-mic" class="text-xs text-red-400 hover:text-red-300">Stop</button>
            </div>
            
            <!-- Metronome Visual Indicator -->
            <div id="metronome-visual" class="mt-4 flex flex-col items-center gap-3">
                <div class="flex gap-2 items-center">
                    <div class="metronome-beat w-4 h-4 rounded-full bg-slate-600 transition-all duration-150" data-beat="0"></div>
                    <div class="metronome-beat w-4 h-4 rounded-full bg-slate-600 transition-all duration-150" data-beat="1"></div>
                    <div class="metronome-beat w-4 h-4 rounded-full bg-slate-600 transition-all duration-150" data-beat="2"></div>
                    <div class="metronome-beat w-4 h-4 rounded-full bg-slate-600 transition-all duration-150" data-beat="3"></div>
                </div>
                
                <!-- Beat Window Meter -->
                <div class="w-full max-w-md">
                    <div class="text-xs text-slate-400 mb-1 text-center">Beat Window</div>
                    <div id="beat-meter" class="relative h-8 bg-slate-700 rounded-full overflow-hidden border border-slate-600">
                        <!-- Green acceptance zone -->
                        <div id="acceptance-zone" class="absolute h-full bg-green-500/30 border-x-2 border-green-400 transition-all duration-75"></div>
                        <!-- Beat indicator (moving dot) -->
                        <div id="beat-indicator" class="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-indigo-500 rounded-full transition-all duration-75 shadow-lg shadow-indigo-500/50"></div>
                    </div>
                    <div class="text-xs text-slate-500 mt-1 text-center">Play notes when indicator is in green zone</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Interface (Piano or Buttons) -->
    <div class="flex-none bg-slate-800 p-2 sm:p-4 pb-8 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)] border-t border-slate-700 z-20">
        
        <!-- Piano Container -->
        <div id="piano-wrapper" class="hidden">
            <div class="max-w-5xl mx-auto relative h-40 sm:h-48 select-none flex" id="piano-container">
                <!-- Keys generated by JS -->
            </div>
            <div class="text-center text-xs text-slate-500 mt-2">Octave matters in Piano Mode</div>
        </div>

        <!-- Button Container -->
        <div id="buttons-wrapper" class="hidden max-w-2xl mx-auto">
            <div class="grid grid-cols-7 gap-2 sm:gap-4">
                <button class="note-btn bg-white text-slate-900 rounded-lg p-4 text-xl font-bold shadow-lg active:bg-slate-200" onmousedown="App.handleInput('C', 4, null)">C</button>
                <button class="note-btn bg-white text-slate-900 rounded-lg p-4 text-xl font-bold shadow-lg active:bg-slate-200" onmousedown="App.handleInput('D', 4, null)">D</button>
                <button class="note-btn bg-white text-slate-900 rounded-lg p-4 text-xl font-bold shadow-lg active:bg-slate-200" onmousedown="App.handleInput('E', 4, null)">E</button>
                <button class="note-btn bg-white text-slate-900 rounded-lg p-4 text-xl font-bold shadow-lg active:bg-slate-200" onmousedown="App.handleInput('F', 4, null)">F</button>
                <button class="note-btn bg-white text-slate-900 rounded-lg p-4 text-xl font-bold shadow-lg active:bg-slate-200" onmousedown="App.handleInput('G', 4, null)">G</button>
                <button class="note-btn bg-white text-slate-900 rounded-lg p-4 text-xl font-bold shadow-lg active:bg-slate-200" onmousedown="App.handleInput('A', 4, null)">A</button>
                <button class="note-btn bg-white text-slate-900 rounded-lg p-4 text-xl font-bold shadow-lg active:bg-slate-200" onmousedown="App.handleInput('B', 4, null)">B</button>
            </div>
            <div class="text-center text-xs text-slate-500 mt-4">Identify the note name (Key Signature applies)</div>
        </div>

    </div>

    <!-- Mic Calibration Modal -->
    <div id="calibration-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 text-white rounded-xl shadow-2xl max-w-2xl w-full p-6 border border-slate-700 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Microphone Calibration</h2>
            
            <div class="space-y-6">
                <!-- Guided Calibration Mode -->
                <div id="guided-calibration" class="bg-slate-900 rounded-lg p-4 space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Guitar String Calibration</h3>
                        <p class="text-sm text-slate-400 mb-4">Play each open string when prompted. This will help calibrate note detection.</p>
                        
                        <div class="mb-4">
                            <div class="text-sm text-slate-300 mb-2">Current String:</div>
                            <div id="cal-current-string" class="text-3xl font-bold text-center py-3 bg-slate-800 rounded">
                                <span class="text-slate-500">Not Started</span>
                            </div>
                        </div>
                        
                        <div class="bg-slate-800 rounded-lg p-4 space-y-3">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Detected Note</label>
                                <div id="cal-guided-detected-note" class="text-2xl font-bold text-center py-2">
                                    <span class="text-slate-500">--</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Frequency (Hz)</label>
                                    <div id="cal-guided-frequency" class="text-lg font-mono text-indigo-400">0.0</div>
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Signal Strength</label>
                                    <div class="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                                        <div id="cal-guided-signal-bar" class="h-full bg-green-500 transition-all duration-100" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mb-4">
                            <button id="btn-start-guided-cal" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-3 rounded-lg font-semibold transition">
                                Start Guided Calibration
                            </button>
                            <button id="btn-skip-guided" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm transition">
                                Skip to Free Mode
                            </button>
                        </div>
                        
                        <button id="btn-next-string" class="hidden w-full bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded-lg font-semibold transition">
                            Next String â†’
                        </button>
                        
                        <div id="cal-progress" class="hidden">
                            <div class="text-xs text-slate-400 mb-2">Progress:</div>
                            <div class="flex gap-2">
                                <div class="cal-string-progress flex-1 h-2 bg-slate-700 rounded" data-string="E6"></div>
                                <div class="cal-string-progress flex-1 h-2 bg-slate-700 rounded" data-string="A"></div>
                                <div class="cal-string-progress flex-1 h-2 bg-slate-700 rounded" data-string="D"></div>
                                <div class="cal-string-progress flex-1 h-2 bg-slate-700 rounded" data-string="G"></div>
                                <div class="cal-string-progress flex-1 h-2 bg-slate-700 rounded" data-string="B"></div>
                                <div class="cal-string-progress flex-1 h-2 bg-slate-700 rounded" data-string="E1"></div>
                            </div>
                        </div>
                        
                        <button id="btn-save-cal-logs" class="hidden w-full bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded-lg font-semibold transition">
                            Save Calibration Logs
                        </button>
                    </div>
                </div>

                <!-- Free Mode -->
                <div id="free-calibration" class="hidden">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Status</label>
                            <div id="cal-status" class="flex items-center gap-2">
                                <div id="cal-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                                <span id="cal-status-text" class="text-sm text-slate-300">Not Listening</span>
                            </div>
                        </div>
                        <button id="btn-start-calibration" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-3 rounded-lg font-semibold transition">
                            Start Free Calibration
                        </button>
                    </div>

                    <div class="bg-slate-900 rounded-lg p-4 space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-400 mb-2">Detected Note</label>
                            <div id="cal-detected-note" class="text-3xl font-bold text-center py-4 bg-slate-800 rounded">
                                <span class="text-slate-500">--</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Frequency (Hz)</label>
                                <div id="cal-frequency" class="text-xl font-mono text-indigo-400">0.0</div>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Octave</label>
                                <div id="cal-octave" class="text-xl font-mono text-indigo-400">--</div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Signal Strength</label>
                            <div class="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div id="cal-signal-bar" class="h-full bg-green-500 transition-all duration-100" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-400 mb-2">Detection History</label>
                        <div id="cal-history" class="bg-slate-900 rounded-lg p-3 max-h-40 overflow-y-auto space-y-1">
                            <div class="text-xs text-slate-500 text-center">No detections yet</div>
                        </div>
                    </div>
                </div>

                <div class="pt-4 border-t border-slate-700 flex justify-end">
                    <button id="btn-close-calibration" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-semibold transition">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 text-white rounded-xl shadow-2xl max-w-md w-full p-6 border border-slate-700 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Settings</h2>
            
            <div class="space-y-6">
                <!-- Mode Settings -->
                <div>
                    <label class="block text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wider">Input Mode</label>
                    <div class="grid grid-cols-3 gap-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-slate-700 p-3 rounded-lg hover:bg-slate-600 transition">
                            <input type="radio" name="input_mode" value="piano" class="w-5 h-5 accent-indigo-500">
                            <span class="font-medium">Piano</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-slate-700 p-3 rounded-lg hover:bg-slate-600 transition">
                            <input type="radio" name="input_mode" value="buttons" class="w-5 h-5 accent-indigo-500">
                            <span class="font-medium">Buttons</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-slate-700 p-3 rounded-lg hover:bg-slate-600 transition">
                            <input type="radio" name="input_mode" value="microphone" class="w-5 h-5 accent-indigo-500">
                            <span class="font-medium">Microphone</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wider">Notes per Round</label>
                    <select id="batch-size" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="1">1 Note (Instant)</option>
                        <option value="4">4 Notes</option>
                        <option value="8">8 Notes (Standard)</option>
                        <option value="12">12 Notes</option>
                    </select>
                </div>

                <!-- Metronome Settings (only for microphone mode) -->
                <div id="metronome-settings">
                    <label class="block text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wider">Metronome</label>
                    <div class="space-y-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-slate-700 p-3 rounded-lg hover:bg-slate-600 transition">
                            <input type="checkbox" id="metronome-enabled" class="w-5 h-5 accent-indigo-500">
                            <span class="font-medium">Enable Metronome (Required for Microphone Mode)</span>
                        </label>
                        <div class="flex items-center gap-4">
                            <label class="text-sm text-slate-300">Tempo (BPM):</label>
                            <input type="range" id="tempo-slider" min="40" max="200" value="120" class="flex-1 accent-indigo-500">
                            <span id="tempo-display" class="text-white font-bold w-12 text-right">120</span>
                        </div>
                    </div>
                </div>

                <!-- Clefs -->
                <div>
                    <label class="block text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wider">Clefs</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer bg-slate-700 p-3 rounded-lg flex-1 hover:bg-slate-600 transition">
                            <input type="checkbox" id="clef-treble" class="w-5 h-5 accent-indigo-500">
                            <span>Treble</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer bg-slate-700 p-3 rounded-lg flex-1 hover:bg-slate-600 transition">
                            <input type="checkbox" id="clef-bass" class="w-5 h-5 accent-indigo-500">
                            <span>Bass</span>
                        </label>
                    </div>
                </div>

                <!-- Keys -->
                <div>
                    <label class="block text-sm font-semibold text-slate-400 mb-2 uppercase tracking-wider">Key Signatures</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-700 cursor-pointer">
                            <input type="checkbox" class="key-sig-opt accent-indigo-500" value="C" checked disabled> <span>C Major / A Minor</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-700 cursor-pointer">
                            <input type="checkbox" class="key-sig-opt accent-indigo-500" value="G"> <span>G Major (1 #)</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-700 cursor-pointer">
                            <input type="checkbox" class="key-sig-opt accent-indigo-500" value="F"> <span>F Major (1 b)</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-700 cursor-pointer">
                            <input type="checkbox" class="key-sig-opt accent-indigo-500" value="D"> <span>D Major (2 #)</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-700 cursor-pointer">
                            <input type="checkbox" class="key-sig-opt accent-indigo-500" value="Bb"> <span>Bb Major (2 b)</span>
                        </label>
                    </div>
                </div>

                <div class="pt-4 border-t border-slate-700 flex justify-between">
                    <button id="btn-reset-data" class="text-red-400 text-sm hover:text-red-300">Reset Progress</button>
                    <div class="flex gap-2">
                        <button id="btn-calibrate-mic" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded-lg text-sm transition">Calibrate Mic</button>
                        <button id="btn-close-settings" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-semibold transition">Save & Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="logger.js"></script>
    <script src="audio.js"></script>
    <script src="metronome.js"></script>
    <script src="pitch-detector.js"></script>
    <script src="srs.js"></script>
    <script src="app.js"></script>
</body>
</html>